$NetBSD: patch-libraries_liblmdb_Makefile,v 1.8 2024/05/13 13:19:59 jperkin Exp $

Libtoolize.
Use proper install commands.

--- libraries/liblmdb/Makefile.orig	2024-01-29 18:52:23.000000000 +0000
+++ libraries/liblmdb/Makefile
@@ -26,7 +26,7 @@ OPT = -O2 -g
 CFLAGS	= $(THREADS) $(OPT) $(W) $(XCFLAGS)
 LDLIBS	=
 SOLIBS	=
-SOEXT	= .so
+SOEXT	= .la
 prefix	= /usr/local
 exec_prefix = $(prefix)
 bindir = $(exec_prefix)/bin
@@ -38,21 +38,21 @@ mandir = $(datarootdir)/man
 ########################################################################
 
 IHDRS	= lmdb.h
-ILIBS	= liblmdb.a liblmdb$(SOEXT)
+ILIBS	= liblmdb$(SOEXT)
 IPROGS	= mdb_stat mdb_copy mdb_dump mdb_load
 IDOCS	= mdb_stat.1 mdb_copy.1 mdb_dump.1 mdb_load.1
 PROGS	= $(IPROGS) mtest mtest2 mtest3 mtest4 mtest5
-all:	$(ILIBS) $(PROGS)
+all:	$(ILIBS) $(IPROGS)
 
 install: $(ILIBS) $(IPROGS) $(IHDRS)
 	mkdir -p $(DESTDIR)$(bindir)
 	mkdir -p $(DESTDIR)$(libdir)
 	mkdir -p $(DESTDIR)$(includedir)
 	mkdir -p $(DESTDIR)$(mandir)/man1
-	for f in $(IPROGS); do cp $$f $(DESTDIR)$(bindir); done
-	for f in $(ILIBS); do cp $$f $(DESTDIR)$(libdir); done
-	for f in $(IHDRS); do cp $$f $(DESTDIR)$(includedir); done
-	for f in $(IDOCS); do cp $$f $(DESTDIR)$(mandir)/man1; done
+	for f in $(IPROGS); do $(BSD_INSTALL_PROGRAM) $$f $(DESTDIR)$(prefix)/bin; done
+	$(LIBTOOL) --mode=install $(BSD_INSTALL_LIB) liblmdb.la $(DESTDIR)$(prefix)/lib
+	for f in $(IHDRS); do $(BSD_INSTALL_DATA) $$f $(DESTDIR)$(prefix)/include; done
+	for f in $(IDOCS); do $(BSD_INSTALL_MAN) $$f $(DESTDIR)$(prefix)/$(PKGMANDIR)/man1; done
 
 clean:
 	rm -rf $(PROGS) *.[ao] *.[ls]o *~ testdb
@@ -66,12 +66,16 @@ liblmdb.a:	mdb.o midl.o
 
 liblmdb$(SOEXT):	mdb.lo midl.lo
 #	$(CC) $(LDFLAGS) -pthread -shared -Wl,-Bsymbolic -o $@ mdb.o midl.o $(SOLIBS)
-	$(CC) $(LDFLAGS) -pthread -shared -o $@ mdb.lo midl.lo $(SOLIBS)
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -pthread -rpath $(PREFIX)/lib -o $@ mdb.lo midl.lo $(SOLIBS)
 
-mdb_stat: mdb_stat.o liblmdb.a
-mdb_copy: mdb_copy.o liblmdb.a
-mdb_dump: mdb_dump.o liblmdb.a
-mdb_load: mdb_load.o liblmdb.a
+mdb_stat: mdb_stat.o liblmdb${SOEXT}
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) $< -L. -llmdb -o $@
+mdb_copy: mdb_copy.o liblmdb${SOEXT}
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) $< -L. -llmdb -o $@
+mdb_dump: mdb_dump.o liblmdb${SOEXT}
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) $< -L. -llmdb -o $@
+mdb_load: mdb_load.o liblmdb${SOEXT}
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) $< -L. -llmdb -o $@
 mtest:    mtest.o    liblmdb.a
 mtest2:	mtest2.o liblmdb.a
 mtest3:	mtest3.o liblmdb.a
@@ -87,10 +91,10 @@ midl.o: midl.c midl.h
 	$(CC) $(CFLAGS) $(CPPFLAGS) -c midl.c
 
 mdb.lo: mdb.c lmdb.h midl.h
-	$(CC) $(CFLAGS) -fPIC $(CPPFLAGS) -c mdb.c -o $@
+	$(LIBTOOL) --mode=compile --tag=CC $(CC) $(CFLAGS) $(CPPFLAGS) -c mdb.c -o $@
 
 midl.lo: midl.c midl.h
-	$(CC) $(CFLAGS) -fPIC $(CPPFLAGS) -c midl.c -o $@
+	$(LIBTOOL) --mode=compile --tag=CC $(CC) $(CFLAGS)  $(CPPFLAGS) -c midl.c -o $@
 
 %:	%.o
 	$(CC) $(CFLAGS) $(LDFLAGS) $^ $(LDLIBS) -o $@
